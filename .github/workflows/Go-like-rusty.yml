name: üèõÔ∏è Go-like-Rust Transpiler (v3.2 ‚Äî Top Contributor Highlight + Summary Stats)

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build/transpiled
  LEDGER_DIR: proof
  SNAPSHOT_TAG: snapshot-v3.2-${{ github.run_number }}
  BACKUP_REPO: r3c-foundation/r3c-backup

jobs:
  transpile:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      - name: ‚öôÔ∏è Setup Go environment (official)
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: ‚öôÔ∏è Setup dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gnuplot
          mkdir -p "$GITHUB_WORKSPACE/$LEDGER_DIR" "$GITHUB_WORKSPACE/$BUILD_DIR"

      # ---------------------------------------------------------
      - name: üèóÔ∏è Build Go-like-Rust binary
        id: build
        run: |
          echo "üèóÔ∏è Building Go-like-Rust transpiler..."
          go mod tidy
          if go build -o "$BUILD_DIR/gcrust" main.go; then
            echo "‚úÖ Build Success" > build_status.txt
          else
            echo "‚ùå Build Failed" > build_status.txt
          fi
          BUILD_RESULT=$(cat build_status.txt)
          echo "build_status=$BUILD_RESULT" >> $GITHUB_OUTPUT
          echo "Build status: $BUILD_RESULT"

      # ---------------------------------------------------------
      - name: üßæ Record contributor ledger
        run: |
          AUTHOR="${{ github.actor }}"
          EMAIL=$(git log -1 --pretty=format:'%ae')
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "[$TIMESTAMP] $AUTHOR <$EMAIL>" >> "$LEDGER_DIR/contributor-ledger.txt"

      # ---------------------------------------------------------
      - name: üßÆ Calculate contributor scores
        run: |
          echo "üë• Character-Based Contribution Scores ‚Äî $(date -u)" > "$LEDGER_DIR/contributor-scores.txt"
          echo "" >> "$LEDGER_DIR/contributor-scores.txt"
          rm -f "$LEDGER_DIR/contributor-rank-data.txt"
          for email in $(git log --format='%ae' | sort | uniq); do
            total_chars=$(git log --author="$email" --pretty=tformat: --numstat | awk '{add+=$1} END {print add}')
            name=$(git log --author="$email" --pretty="%aN" | head -n 1)
            [ -z "$total_chars" ] && total_chars=0
            printf "%-25s ‚Äî %10d chars\n" "$name <$email>" "$total_chars" >> "$LEDGER_DIR/contributor-scores.txt"
            echo "$name $total_chars" >> "$LEDGER_DIR/contributor-rank-data.txt"
          done

      # ---------------------------------------------------------
      - name: üìà Generate contributor rank graph
        run: |
          cd "$LEDGER_DIR"
          if [ -s contributor-rank-data.txt ]; then
            sort -k2 -nr contributor-rank-data.txt > rank-sorted.txt
            echo "set terminal svg size 900,400; \
                  set output 'contributor-rank.svg'; \
                  set title 'Go-like-Rust Contributor Ranking'; \
                  set style data histograms; \
                  set style fill solid; \
                  set boxwidth 0.5; \
                  set ylabel 'Characters Added'; \
                  set xtics rotate by -25; \
                  plot 'rank-sorted.txt' using 2:xtic(1) title 'Char Count'" | gnuplot
            echo "‚úÖ Graph generated at proof/contributor-rank.svg"
          fi

      # ---------------------------------------------------------
      - name: ü•á Extract Top 3 contributors
        id: top3
        run: |
          cd "$LEDGER_DIR"
          sort -k2 -nr contributor-rank-data.txt | head -n 3 > top3.txt
          echo "Top 3 Contributors:"
          cat top3.txt
          top1=$(sed -n '1p' top3.txt | awk '{print $1}')
          top2=$(sed -n '2p' top3.txt | awk '{print $1}')
          top3=$(sed -n '3p' top3.txt | awk '{print $1}')
          echo "top1=$top1" >> $GITHUB_OUTPUT
          echo "top2=$top2" >> $GITHUB_OUTPUT
          echo "top3=$top3" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      - name: üß© Embed stats, top3, build badge + graph into README
        run: |
          STATUS="${{ steps.build.outputs.build_status }}"
          STATUS_CLEAN=$(echo "$STATUS" | tr ' ' '_' | tr -d '[:punct:]')
          BUILD_BADGE="![Build Status](https://img.shields.io/badge/build-${STATUS_CLEAN}-blue.svg)"
          GRAPH_PATH="proof/contributor-rank.svg"
          RAW_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/${GRAPH_PATH}"

          COMMITS=$(git rev-list --count HEAD)
          CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
          UPDATED=$(date -u '+%Y-%m-%d %H:%M UTC')

          TOP1="${{ steps.top3.outputs.top1 }}"
          TOP2="${{ steps.top3.outputs.top2 }}"
          TOP3="${{ steps.top3.outputs.top3 }}"

          echo "ü™∂ Updating README..."
          sed -i '/## üèóÔ∏è Build Status/,$d' README.md 2>/dev/null || true
          {
            echo "# üß© Go-like-Rust Transpiler"
            echo ""
            echo "üìä **Commits:** $COMMITS‚ÄÉüë• **Contributors:** $CONTRIBUTORS‚ÄÉüïí **Updated:** $UPDATED"
            echo ""
            echo "üèÜ **Top Contributors:** ü•á $TOP1‚ÄÉü•à $TOP2‚ÄÉü•â $TOP3"
            echo ""
            echo "## üèóÔ∏è Build Status"
            echo ""
            echo "$BUILD_BADGE"
            echo ""
            echo "## üèÜ Contributor Ranking"
            echo ""
            echo "![Contributor Rank Graph]($RAW_URL)"
            echo ""
            echo "_(Auto-generated by CI ‚Äî build + rank + stats updated each push)_"
          } > README.md

          git add README.md
          git commit -m "üèóÔ∏è Auto-update top3 + stats + build badge + graph in README" || echo "No changes"
          git push origin main || echo "‚úÖ No push needed"

      # ---------------------------------------------------------
      - name: üåÄ Create snapshot release (with binary + proof + graph)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üåÄ Creating release: $SNAPSHOT_TAG"
          gh release delete "$SNAPSHOT_TAG" --yes || true
          gh release create "$SNAPSHOT_TAG" \
            "$BUILD_DIR/gcrust" \
            "$GITHUB_WORKSPACE/$LEDGER_DIR/contributor-ledger.txt" \
            "$GITHUB_WORKSPACE/$LEDGER_DIR/contributor-scores.txt" \
            "$GITHUB_WORKSPACE/$LEDGER_DIR/contributor-rank.svg" \
            "$GITHUB_WORKSPACE/$LEDGER_DIR/top3.txt" \
            --title "Go-like-Rust Snapshot v3.2" \
            --notes "Added top3 highlight + summary stats ‚Äî $(date -u)" || true

      # ---------------------------------------------------------
      - name: üì¶ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gcrust-v3.2-${{ github.run_number }}
          path: |
            $BUILD_DIR/
            $LEDGER_DIR/
