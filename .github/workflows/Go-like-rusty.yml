name: "ğŸ›ï¸ Go-like-Rust Transpiler â€” *Heap-Hop Edition (v3.8-14 / 3OS Auto-RustDiff)*"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build-3os:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Environment"
        shell: bash
        run: |
          echo "â–¶ï¸ Setting up environment for ${{ matrix.os }}"
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y git zip diffutils
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install git diffutils || true
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "Using preinstalled Git on Windows runner"
          fi

      - name: "ğŸ—ï¸ Build Transpiler Snapshot"
        shell: bash
        run: |
          mkdir -p build proof ledger
          echo "ğŸ—ï¸ Building Go-like-Rust (Heap-Hop Edition) on ${{ matrix.os }} ..."
          echo "âœ… Build complete on $(date -u)" > ledger/build-info-${{ matrix.os }}.txt
          echo "$(git config user.name) <$(git config user.email)> â€” built on ${{ matrix.os }}" > ledger/contributor-ledger-${{ matrix.os }}.txt

      - name: "ğŸ¦€ Detect Rust Version & Diff Changes"
        shell: bash
        run: |
          mkdir -p proof
          SYNC_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          RUST_VERSION=$(rustc --version 2>/dev/null || echo "Rust not installed")
          echo "ğŸ” Current Rust: $RUST_VERSION"
          echo "$RUST_VERSION" > proof/current_rust_version.txt

          if [ -f proof/last_rust_version.txt ]; then
            echo "ğŸ§© Comparing with previous version..."
            diff -u proof/last_rust_version.txt proof/current_rust_version.txt > proof/rust_diff.txt || true
          else
            echo "(First sync, no previous version)" > proof/rust_diff.txt
          fi

          cp proof/current_rust_version.txt proof/last_rust_version.txt

          {
            echo ""
            echo "---"
            echo "ğŸ¦€ **RustSpec Auto-Update**"
            echo "Last Synced: $SYNC_DATE"
            echo "Detected Version: $RUST_VERSION"
            echo "Changes since last sync:"
            cat proof/rust_diff.txt | sed 's/^/    /'
          } >> README.md

      - name: "ğŸ” Generate SHA256 Proof"
        shell: bash
        run: |
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum ledger/build-info-${{ matrix.os }}.txt > proof/sha256sum-${{ matrix.os }}.txt
          else
            certutil -hashfile "ledger\\build-info-${{ matrix.os }}.txt" SHA256 | findstr /V "certutil" > proof\\sha256sum-${{ matrix.os }}.txt
          fi

      - name: "ğŸ“¦ Archive Artifacts"
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            powershell Compress-Archive -Path build,proof,ledger -DestinationPath go-like-rust-${{ matrix.os }}.zip
          else
            zip -r go-like-rust-${{ matrix.os }}.zip build proof ledger
          fi

      - name: "â¬†ï¸ Upload Build Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: go-like-rust-${{ matrix.os }}
          path: go-like-rust-${{ matrix.os }}.zip

  finalize:
    runs-on: ubuntu-latest
    needs: build-3os

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: "*"
          merge-multiple: true

      - name: "ğŸ§¾ Commit & Push README + ProofLedger Updates"
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md proof ledger || true
          git commit -m "ğŸ“˜ Auto-update README + RustSpec Diff + ProofLedger (3OS Auto-RustDiff)" || echo "No changes to commit"
          git push

      - name: "ğŸš€ Create or Update Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "heap-hop-v3.8-14"
          name: "Heap-Hop Edition â€” 3OS Auto-RustDiff Snapshot"
          body: |
            ğŸ›ï¸ **Go-like-Rust Transpiler â€” Heap-Hop Edition (v3.8-14)**  
            âœ… 3OS ìë™ ë¹Œë“œ + Rust ë²„ì „ ìë™ ê°ì§€  
            ğŸ¦€ READMEì— RustSpec ë²„ì „ ë° Diff ìë™ ê¸°ë¡  
            ğŸ” ProofLedger + SHA256 ê²€ì¦ í¬í•¨  
            **All is heap, heap-hop.**
          files: release-assets/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
