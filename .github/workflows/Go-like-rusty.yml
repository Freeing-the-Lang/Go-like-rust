Name: "Go-like-Rust Transpiler â€” All is Heap (Heap-Hop Edition v4.10.5 / Go Executable Release)"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

# ê¶Œí•œì„ ìµœìƒìœ„ê°€ ì•„ë‹Œ ì‘ì—…(Job) ë‹¨ìœ„ë¡œ ì œì–´í•˜ì—¬ ë³´ì•ˆ ê°•í™”
permissions:
  contents: read

concurrency:
  group: go-like-rust-heap-hop-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read # ë¹Œë“œ ì‘ì—…ì€ ì†ŒìŠ¤ ì½ê¸° ê¶Œí•œë§Œ í•„ìš”
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    # Windowsì—ì„œë„ bashë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë³µ ì œê±°
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ë¹Œë“œì—ëŠ” ì „ì²´ íˆìŠ¤í† ë¦¬ê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ 1ë¡œ ì„¤ì •í•˜ì—¬ ì†ë„ í–¥ìƒ

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          check-latest: true
          cache: true # cache: true ì˜µì…˜ë§Œìœ¼ë¡œ ìë™ ìºì‹± ê°€ëŠ¥

      - name: Transpile Rust to Go (Unified)
        run: |
          set -euo pipefail
          mkdir -p build transpiled proof ledger
          
          echo "âš™ï¸ Translating Rust to Go-like heap-based code..."
          
          # Python ê°ì§€ ë° íŠ¸ëœìŠ¤íŒŒì¼ëŸ¬ ì‹¤í–‰ (OS êµ¬ë¶„ ì—†ì´ Bash ë¡œì§ í†µì¼)
          TRANSPILER="scripts/translate_rust_to_go.py"
          GENERATED=false
          
          if [ -f "$TRANSPILER" ]; then
            echo "Found Python transpiler â€” executing..."
            if python3 "$TRANSPILER" src/ > transpiled/main.go 2>/dev/null; then
              GENERATED=true
            elif python "$TRANSPILER" src/ > transpiled/main.go 2>/dev/null; then
              GENERATED=true
            fi
          fi

          if [ "$GENERATED" = false ]; then
            echo "âš ï¸ No transpiler found or execution failed â€” creating fallback Go file."
            cat <<EOF > transpiled/main.go
          package main
          import (
            "bufio"
            "fmt"
            "os"
          )
          func main() {
            fmt.Println("All is heap â€” Heap-Hop Edition running.")
            fmt.Println("Every value lives on the heap.")
            fmt.Println("Press ENTER to exit.")
            reader := bufio.NewReader(os.Stdin)
            _, _ = reader.ReadBytes('\n')
          }
          EOF
          fi
          
          echo "âœ… Transpilation complete."

      - name: Build Go Executable
        run: |
          set -euo pipefail
          cd transpiled
          
          # OS ì´ë¦„ ì†Œë¬¸ì ë³€í™˜ (Bash ê¸°ëŠ¥ í™œìš©)
          GOOS_NAME=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          OUT="../build/go_like_rust_${GOOS_NAME}"
          
          # Windows í™•ì¥ì ì²˜ë¦¬
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            OUT="${OUT}.exe"
          fi
          
          echo "Building for $GOOS_NAME..."
          go build -trimpath -ldflags="-s -w" -o "${OUT}" main.go
          
          cd ..
          {
            echo "Version: v4.10.5"
            date -u +"Build Time (UTC): %Y-%m-%dT%H:%M:%SZ"
            echo "Commit Hash: ${{ github.sha }}"
            echo "Runner OS: ${{ runner.os }}"
          } > "ledger/build-info-${GOOS_NAME}.txt"

      - name: Generate SHA256 Proof
        run: |
          set -euo pipefail
          mkdir -p proof
          
          # OS ë¬´ê´€í•˜ê²Œ í˜¸í™˜ë˜ëŠ” í•´ì‹œ ê³„ì‚° ë¡œì§ (find + sha256sum/shasum)
          # Git Bash(Windows)ì—ëŠ” sha256sumì´ í¬í•¨ë˜ì–´ ìˆìŒ
          if command -v sha256sum >/dev/null 2>&1; then
            find build -type f -print0 | xargs -0 sha256sum | sort > "proof/sha256sum-${{ matrix.os }}.txt"
          else
            find build -type f -exec shasum -a 256 "{}" \; | sort > "proof/sha256sum-${{ matrix.os }}.txt"
          fi

      - name: Archive Artifacts
        run: |
          set -euo pipefail
          mkdir -p release-assets
          ZIP="release-assets/go-like-rust-${{ matrix.os }}.zip"
          
          # zip ëª…ë ¹ì–´ê°€ ì—†ëŠ” ìœˆë„ìš° í™˜ê²½ ëŒ€ë¹„ (ë³´í†µ Git Bashì—” ìˆì§€ë§Œ ì•ˆì „í•˜ê²Œ 7z í™•ì¸)
          if command -v zip >/dev/null 2>&1; then
            zip -rq "$ZIP" build proof ledger transpiled
          elif command -v 7z >/dev/null 2>&1; then
            7z a "$ZIP" build proof ledger transpiled >/dev/null
          else
            echo "Error: Neither zip nor 7z found."
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: go-like-rust-${{ matrix.os }}-${{ github.run_id }}
          path: release-assets/go-like-rust-${{ matrix.os }}.zip
          if-no-files-found: error
          retention-days: 1

  finalize:
    runs-on: ubuntu-latest
    needs: build-3os
    permissions:
      contents: write # ì»¤ë°‹ ë° ë¦´ë¦¬ìŠ¤ ìƒì„± ê¶Œí•œ í•„ìš”

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì»¤ë°‹ì„ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (í˜¹ì€ ë¦¬ë² ì´ìŠ¤ë¥¼ ìœ„í•´)

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: "go-like-rust-*"
          merge-multiple: true

      - name: Extract proof/ledger
        run: |
          set -euo pipefail
          mkdir -p proof ledger
          # unzip ì‚¬ìš©
          for z in release-assets/*.zip; do
            unzip -qo "$z" "proof/*" "ledger/*" -d tmp || true
            cp -R tmp/proof/* proof/ 2>/dev/null || true
            cp -R tmp/ledger/* ledger/ 2>/dev/null || true
            rm -rf tmp
          done

      - name: Commit & Push ProofLedger
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git pull --rebase --autostash || true
          
          if ! grep -q "### Main Branch Open" README.md; then
            echo -e "\n### Main Branch Open\nThe main branch is open for contributions via PR or Issues." >> README.md
          fi
          
          git add README.md proof ledger || true
          
          # [skip ci] ì¶”ê°€: ì´ ì»¤ë°‹ìœ¼ë¡œ ì¸í•´ ì›Œí¬í”Œë¡œê°€ ë¬´í•œ ë£¨í”„ ë„ëŠ” ê²ƒì„ ë°©ì§€
          if ! git diff --cached --quiet; then
            git commit -m "Main branch open notice + Proof/Ledger sync (v4.10.5) [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Compute date for tag
        id: dates
        run: echo "utc_date=$(date -u +%Y%m%d)" >> "$GITHUB_OUTPUT"

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: heap-hop-${{ github.run_number }}-${{ steps.dates.outputs.utc_date }}
          name: "Heap-Hop Edition â€” All is Heap Executable (Go-like Rust Transpiler v4.10.5)"
          body: |
            Go-like-Rust Transpiler â€” All is Heap (v4.10.5)
            âœ… Rust â†’ Go heap mode executable release
            ğŸ” ProofLedger + SHA256 verification
            âš™ï¸ Everything lives on the heap.
          files: release-assets/*.zip
          allowUpdates: true
